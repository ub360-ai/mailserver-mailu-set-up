version: '3.3'

services:

  # External-facing reverse proxy for TLS and port management
  # 80/443 not published: Coolify's proxy owns them and routes to front:80 internally
  front:
    image: ghcr.io/mailu/nginx:2024.06
    restart: always
    env_file: mailu.env
    logging:
      driver: json-file
    ports:
      - "0.0.0.0:25:25"
      - "0.0.0.0:465:465"
      - "0.0.0.0:587:587"
      - "0.0.0.0:110:110"
      - "0.0.0.0:995:995"
      - "0.0.0.0:143:143"
      - "0.0.0.0:993:993"
      - "0.0.0.0:4190:4190"
    volumes:
      - "/mailu/certs:/certs"
      - "/mailu/overrides/nginx:/overrides:ro"
    networks:
      - default

  # Internal DNS resolver to prevent leak of internal queries
  resolver:
    image: ghcr.io/mailu/unbound:2024.06
    restart: always
    env_file: mailu.env
    networks:
      - default

  # Administration interface
  admin:
    image: ghcr.io/mailu/admin:2024.06
    restart: always
    env_file: mailu.env
    volumes:
      - "/mailu/data:/data"
      - "/mailu/dkim:/dkim"
    networks:
      - default

  # IMAP and POP3 server
  imap:
    image: ghcr.io/mailu/dovecot:2024.06
    restart: always
    env_file: mailu.env
    volumes:
      - "/mailu/mail:/mail"
      - "/mailu/overrides/dovecot:/overrides:ro"
    networks:
      - default

  # SMTP server
  smtp:
    image: ghcr.io/mailu/postfix:2024.06
    restart: always
    env_file: mailu.env
    volumes:
      - "/mailu/mailqueue:/queue"
      - "/mailu/overrides/postfix:/overrides:ro"
    networks:
      - default

  # Antispam engine (Rspamd)
  antispam:
    image: ghcr.io/mailu/rspamd:2024.06
    restart: always
    env_file: mailu.env
    volumes:
      - "/mailu/filter:/var/lib/rspamd"
      - "/mailu/overrides/rspamd:/overrides:ro"
    networks:
      - default

  # Web branding and static files (optional, but good for UI)
  webmail:
    image: ghcr.io/mailu/webmail:2024.06
    restart: always
    env_file: mailu.env
    volumes:
      - "/mailu/webmail:/data"
      - "/mailu/overrides/roundcube:/overrides:ro"
    networks:
      - default

  # Redis for caching and rate limiting
  redis:
    image: redis:7-alpine
    restart: always
    volumes:
      - "/mailu/redis:/data"
    networks:
      - default

networks:
  default:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 192.168.203.0/24
